<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Canvas</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script async src="https://docs.opencv.org/3.4/opencv.js"></script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <style type="text/css">
        #container {
            margin: 0px auto;
            width: 500px;
            height: 375px;
            border: 10px #333 solid;
        }
        #videoElement {
            width: 500px;
            height: 375px;
            background-color: #666;
        } 
        .hideButTakeUpSpace
        {
            /* visibility: hidden; */
            visibility: none;
        }

        .hideDontTakeUpSpace
        {
            display:none;
        }
        /* .gap{width:200px;background:none;height:110px;display:inline-block;} */

    </style>
</head>
<body>

<div style="margin: 30px">
    <div style="float: left">
        <!-- 204*4, 240*4 -->
        <canvas style="border: 1px solid black" id="canvas" width="310" height="600">
        </canvas>
    </div>

    <div style="float: left; margin-left: 10px;">
        <div style="margin-top: 2px">
            destination X :
            <input type="number" id="destination_x" min="0" max="100">
        </div>

        <div style="margin-top: 2px">
            destination Y :
            <input type="number" id="destination_y" min="0" max="100">
        </div>

        <div style="margin-top: 2px">
            <input type="button" id="apply_destination" value="적용">
        </div>
        <div style="margin-top: 2px">
            <input type="button" id="apply_clear" value="goto (0,0)">
        </div>
        <div style="margin-top: 2px">
            <input type="button" id="apply_goto100" value="goto (100,100)">
        </div>
        <div style="margin-top: 2px">
            <input type="button" id="apply_random" value="goto random(0,100)">
        </div>
        <br>
        <p>
            <label>x,y entered when &ensp;<br> mouse click within canvas</label>
        </p>
    </div>

    <!-- <div style="float: left; margin-left: 10px;">
        <div style="margin-top: 2px">
            X :
            <input type="number" id="x" min="0" max="100">
        </div>

        <div style="margin-top: 2px">
            Y :
            <input type="number" id="y" min="0" max="100">
        </div>

        <div style="margin-top: 2px">
            <input type="button" id="apply" value="적용">
        </div>
    </div> -->
    
</div>
<!-- 출력 area -->
&emsp; 
<br/>
<!-- <textarea class="hideDontTakeUpSpace" id="messageTextArea" rows="15" cols="50"></textarea> -->
<textarea id="messageTextArea" rows="15" cols="50"></textarea>
<!-- <div class='gap'></div>-->
<!-- <div id="container">
    <video autoplay="true" id="videoElement">
    
    </video>
</div>   -->


<br/>
<video id="video"></video>
<br/>



<label id="constatus">  </label> 
<br/>
<input onclick="connect()" value="Connect" type="button">
<input onclick="disconnect()" value="Disconnect" type="button">
<!-- <br/>
<textarea id="recvTextArea" rows="5" cols="50"></textarea> -->


<script type="text/javascript">

// var video = document.querySelector("#videoElement");
 
// if (navigator.mediaDevices.getUserMedia) {
//   navigator.mediaDevices.getUserMedia({ video: true })
//     .then(function (stream) {
//       video.srcObject = stream;
//     })
//     .catch(function (err0r) {
//       console.log("Something went wrong!");
//     });
// }  //video

    const video = document.getElementById("video");
    const uri = "ws://localhost:9999"
    var webSocket = new WebSocket(uri);
    const canvas_resolution_width = 310
    const canvas_resolution_height = 600
    var img = new Image();
    // let pre_gX=0;
    // let pre_gY=0;
    // 소켓 접속이 되면 호출되는 함수
    webSocket.onopen = function(message){
        messageTextArea.value += "Server connect...\n";
        document.getElementById('constatus').innerHTML = 'websocket server connected';
        };
     // 소켓 접속이 끝나면 호출되는 함수
     webSocket.onclose = function(message){
      messageTextArea.value += "Server Disconnect...\n";
      document.getElementById('constatus').innerHTML = 'websocket server disconnected';
    };
    // 소켓 통신 중에 에러가 발생되면 호출되는 함수
    webSocket.onerror = function(message){
      messageTextArea.value += "error...\n";
    };
    // 소켓 서버로 부터 메시지가 오면 호출되는 함수.
    webSocket.onmessage = function(message){
      // 출력 area에 메시지를 표시한다.
        // messageTextArea.value += "Recieve From Server => "+message.data+"\n";
        let parsed_result = jsonfuncimage(message.data);
        
        // let gX = xy.x;
        // let gY = xy.y;

        // // gX = gX* 2.52;//for test
        // // gY= gY * 5.04;//for test

        // // const amount=5

        // // x = valueX*3.1/100;// for sending
        // // y = valueY*6/100; //for sending
        
        // // gX = gX*100/3.1; // for receiving
        // // gY = gY*100/6; //for receiving
        // gX = gX*100; // for receiving
        // gY = gY*100; //for receiving
        // let temp=0;
        // temp = gX
        // gX = gY
        // gY = temp

         


        // const xmax = 305
        // const ymax = 595
        // const xymin = 5
        // if(gX>xmax)
        //     gX  = xmax;
        // else if(gX <xymin)
        //     gX  = xymin;

        // if(gY>ymax)
        //     gY  = ymax;
        // else if(gY <xymin)
        //     gY  = xymin;
        

         let ctx;
        // const restNum = 10;
        // // messageTextArea.value += "before gX => "+ gX +", before gY=> "+ gY +"\n";
        // // gX = Math.round((gX*81.6)-10)
        // // gY = Math.round((gY*96)-10)
        // messageTextArea.value += "gX => "+ gX +", gY=> "+ gY +"\n";
        if(parsed_result.datatype == "image")
        {
            const canvas = document.getElementById("canvas");            
            ctx = canvas.getContext("2d");



            canvas.width = parsed_result.shape[0]
            canvas.height = parsed_result.shape[1]
            
            // if (canvas.getContext && (pre_gX != gX || pre_gY != gY) && (gX % restNum == 0|| gY % restNum == 0)) {
            if (canvas.getContext) {
                
                $().ready (function(){ 
                
                //console.log(str);
                // img.src = "data:image/jpg;base64," + window.atob(parsed_result.content);
                img.src = "data:image/jpg;base64, " +parsed_result.content;
                // img.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAIAAAACDbGyAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9oMCRUiMrIBQVkAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAADElEQVQI12NgoC4AAABQAAEiE+h1AAAAAElFTkSuQmCC";
                // img.src = "./green.jpeg"
                // img.src="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==";
                img.onload = function () {
                    ctx.drawImage(img,10,10);
                    };

                });
            };
            // pre_gX = gX;
            // pre_gY = gY;
            // src = new cv.Mat(canvas.height, canvas.width, cv.CV_8UC4);
            // src = parsed_result.content
            // cv.imshow('canvas', src);
        }
 
 
        
        
    }  
    //mouse event below
    // function printMousePos(event) {
    // messageTextArea.value +=
    // "clientX: " + event.clientX +
    // " - clientY: " + event.clientY+"\n";
    // }
    // document.addEventListener("click", printMousePos);

    function getCursorPosition(canvas, event) {
    const rect = canvas.getBoundingClientRect()
    let x = event.clientX - rect.left
    let y = event.clientY - rect.top
    console.log("x: " + x + " y: " + y)
    messageTextArea.value +=
    "canvasX: " + x +
    " - canvasY: " + y+"\n";
    $('#destination_x').val(100*x/canvas_resolution_width)
    $('#destination_y').val(100*y/canvas_resolution_height)

    x =x-10;
    y = y-10
    
    // x = x * 3.1;
    // y = y * 6;

    // x = x - 10;
    // y = y - 10;
    // // x = x - 5;
    // // y = y - 5;

    drawMap(x, y);




    }

    const canvas = document.querySelector('canvas')
    canvas.addEventListener('mousedown', function(e) {
        getCursorPosition(canvas, e)
    })

    //socket connect
    function disconnect(){
        if (webSocket.readyState === WebSocket.OPEN) {
            webSocket.close();
            // webSocket = null;
            console.log('closed');
        }
    }
    function connect(){
        if (webSocket.readyState === WebSocket.CLOSED) {
            
            ws2 = new WebSocket(uri);
            ws2.onopen=webSocket.onopen;
            ws2.onmessage = webSocket.onmessage;
            ws2.onclose = webSocket.onclose;
            ws2.onerror = webSocket.onerror;
            webSocket = ws2
            console.log('connected');
        }
       
    }

    function stringToJson(input) {
              var result = [];

              //replace leading and trailing [], if present
              input = input.replace(/^\[/,'');
              input = input.replace(/\]$/,'');

              //change the delimiter to 
              input = input.replace(/},{/g,'};;;{');

              // preserve newlines, etc - use valid JSON
              //https://stackoverflow.com/questions/14432165/uncaught-syntaxerror-unexpected-token-with-json-parse
            input = input.replace(/\\n/g, "\\n")  
            .replace(/\\'/g, "\\'")
            .replace(/\\"/g, '\\"')
            .replace(/\\&/g, "\\&")
            .replace(/\\r/g, "\\r")
            .replace(/\\t/g, "\\t")
            .replace(/\\b/g, "\\b")
            .replace(/\\f/g, "\\f");
            // remove non-printable and other non-valid JSON chars
            input = input.replace(/[\u0000-\u0019]+/g,""); 

            //   input = input.split(';;;');

            //   input.forEach(function(element) {
            //     // console.log(JSON.stringify(element));

            //     result.push(JSON.parse(element));
            //   }, this);

            //   return result;
            return input;
            }


    function jsonfunc( jsonText ) {
        // console.log(typeof(jsonText))
        console.log(jsonText)
        messageTextArea.value += "jsonText=> "+jsonText+"\n";
        // let jload = JSON.loads(jsonText)
        // messageTextArea.value += "jload=> "+jload+"\n";
        // jsonText = jsonText.replace(/^\s+|\s+$/g, "");

        // jsonText = "'"+jsonText+"'";
        // console.log(jsonText)
        // jsonText = stringToJson(jsonText);
        // console.log("-----------------------");
        // console.log(jsonText);
        let json = jQuery.parseJSON(jsonText); // String -> json으로 변환
        // let json = JSON.parse(JSON.stringify(jsonText)); // String -> json으로 변환
        // let json = jsonText;
        
        messageTextArea.value += "json.xNowPose=> "+json.xNowPose+"\n";
        messageTextArea.value += "json.yNowPose=> "+json.yNowPose+"\n";
        // gX = json.xNowPose;
        // gX = json.yNowPose;

        // let txt = "";
        // // 접근법 1
        // messageTextArea.value += "json.length=> "+json.length+"\n";
        // for(i=0; i<json.length; i++){
           
        //     for(key in json[i]){ // key값 가져오기
        //         txt += key + ":" + json[i][key];
        //         messageTextArea.value += "key=> "+key+" ,json[i][key]=> "+json[i][key]+"\n"; 
        //     }
        //     txt += "<br>";
        // } 
        // // document.getElementById('demo').innerHTML = txt;
        // messageTextArea.value += "json parse => "+txt+"\n";

            return {
            x: json.xNowPose,
            y: json.yNowPose
        };
    }

    function jsonfuncimage( jsondata ) {
        // console.log(typeof(jsonText))
        console.log(jsondata)
        // messageTextArea.value += "jsonText=> "+jsondata+"\n";
        // let jload = JSON.loads(jsonText)
        // messageTextArea.value += "jload=> "+jload+"\n";
        // jsonText = jsonText.replace(/^\s+|\s+$/g, "");

        // jsonText = "'"+jsonText+"'";
        // console.log(jsonText)
        // jsonText = stringToJson(jsonText);
        // console.log("-----------------------");
        // console.log(jsonText);
        let json = jQuery.parseJSON(jsondata); // String -> json으로 변환
        // let json = JSON.parse(JSON.stringify(jsonText)); // String -> json으로 변환
        // let json = jsonText;
        
        // messageTextArea.value += "json.datatype=> "+json.datatype+"\n";
        // messageTextArea.value += "json.content=> "+json.content+"\n";
        // messageTextArea.value += "json.shape=> "+json.shape+"\n";
        // gX = json.xNowPose;
        // gX = json.yNowPose;

        // let txt = "";
        // // 접근법 1
        // messageTextArea.value += "json.length=> "+json.length+"\n";
        // for(i=0; i<json.length; i++){
           
        //     for(key in json[i]){ // key값 가져오기
        //         txt += key + ":" + json[i][key];
        //         messageTextArea.value += "key=> "+key+" ,json[i][key]=> "+json[i][key]+"\n"; 
        //     }
        //     txt += "<br>";
        // } 
        // // document.getElementById('demo').innerHTML = txt;
        // messageTextArea.value += "json parse => "+txt+"\n";

            return {
            datatype: json.datatype,
            content: json.content,
            shape : json.shape
        };
    }

    $(function () {
        draw();
        // document.getElementById('constatus').innerHTML = 'label';
        // if (webSocket.readyState === WebSocket.OPEN) {
        //     document.getElementById('constatus').innerHTML = 'connected';
        // }
        // else if(webSocket.readyState === WebSocket.CLOSED)
        // {
        //     document.getElementById('lbltipAddedComment').innerHTML = 'disconneted';
        // }
    });


    $('#apply').click(() => {
        let x = $('#x').val()
        let y = $('#y').val()

        if (x.length === 0 || y.length === 0) {
            alert('Invalid input X, Y');
            return;
        }

        const valueX = Number(x)
        const valueY = Number(y)
        if (0 > valueX || 100 < valueX || 0 > valueY || 100 < valueY) {
            alert('Invalid Value X, Y');
            return;
        }

        x = x * 2.52;
        y = y * 5.04;

        x = x - 10;
        y = y - 10;

        

        let ctx;
        const canvas = document.getElementById("canvas");
        if (canvas.getContext) {
            ctx = canvas.getContext("2d");
            ctx.fillStyle = "rgb(178,34,34)";
            ctx.fillRect(x, y, 20, 20);
        }

        


    })


    function draw() {
        let ctx;
        const canvas = document.getElementById("canvas");
        if (canvas.getContext) {
            ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);//lsc
        }

        let img = new Image();
        img.onload = function () {
            ctx.drawImage(img, 0, 0, canvas_resolution_width, canvas_resolution_height)
        }
        img.src = 'map_rect_310_600.png';
    }

// below distionation related code 
    function drawPoint(x, y) {
        let ctx;
        const canvas = document.getElementById("canvas");
        if (canvas.getContext) {
            ctx = canvas.getContext("2d");
            //ctx.fillStyle = "rgb(178,34,34)";
            //ctx.fillRect(x, y, 20, 20);

            let img = new Image();
            img.src = 'point.png';
            img.onload = function () {
                ctx.drawImage(img, x, y, 24, 24);
            }
            
        }
    }

    function drawMap(x, y) {
        let ctx;
        const canvas = document.getElementById("canvas");
        if (canvas.getContext) {
            ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);//lsc
        }

        let img = new Image();
        img.onload = function () {
            ctx.drawImage(img, 0, 0, canvas_resolution_width, canvas_resolution_height);

            if (x !== -1 && y !== -1) {
                drawPoint(x, y);
                // drawPoint(y, x);
            }
        }
        img.src = 'map_rect_310_600.png';
    }

    
    $('#apply_clear').click(() => {
        $('#destination_x').val(0);
        $('#destination_y').val(0);
        // x = x * 3.1;
        // y = y * 6;

        // x = x - 10;
        // y = y - 10;
        // // x = x - 5;
        // // y = y - 5;

        const x = 0;
        const y = 0;

        drawMap(x, y);
        
    })
    $('#apply_goto100').click(() => {
        $('#destination_x').val(100);
        $('#destination_y').val(100);       
        // x = x * 3.1;
        // y = y * 6;

        // x = x - 10;
        // y = y - 10;
        // // x = x - 5;
        // // y = y - 5;
        const x = 310-10;
        const y = 600-10;
        

        drawMap(x, y);
        
    })
   
    $('#apply_random').click(() => {
        let x = Math.floor(Math.random() * 101);
        let y = Math.floor(Math.random() * 101);
        $('#destination_x').val(x);
        $('#destination_y').val(y);

        x =x*3.1-10;
        y = y*6-10
       
        // x = x * 3.1;
        // y = y * 6;

        // x = x - 10;
        // y = y - 10;
        // // x = x - 5;
        // // y = y - 5;

        drawMap(x, y);
        
    })


    $('#apply_destination').click(() => {
        let x = $('#destination_x').val()
        let y = $('#destination_y').val()
        messageTextArea.value="";

        messageTextArea.value += "input => "+"x : "+x+", y : "+y+"\n";


        if (x.length === 0) {
            // alert('Invalid input X, Y');
            // return;
            x =0;
             
        }
        if (y.length === 0) {
            // alert('Invalid input X, Y');
            // return;
            
            y =0;
        }

        const valueX = Number(x)
        const valueY = Number(y)
        if (0 > valueX || 100 < valueX || 0 > valueY || 100 < valueY) {
            alert('Invalid Value X, Y');
            return;
        }

        
        // x = x * 3.1;
        // y = y * 6;

        // x = x - 10;
        // y = y - 10;
        // // x = x - 5;
        // // y = y - 5;

        // drawMap(x, y);
        // drawPoint(x, y);

        // x = (x + 10)/81.6;
        // y = (y + 10)/96;
        // x = valueX*3.1/100;
        // y = valueY*6/100;
        x = valueX*3.1/100;
        y = valueY*6/100;
        
        // var float64 = new Float64Array(2);
        // float64[0] = x;
        // float64[1] = y;
        // float64[0] = y;
        // float64[1] = x;
        // messageTextArea.value += "Send to Server => "+"x : "+x+", y : "+y+"\n";
        
        //웹소켓으로 textMessage객체의 value을 보낸다.
        
        let webSockData = {
            // xGoalPose: x,
            // yGoalPose: y
            // xGoalPose: y,
            // yGoalPose: x
            datatype : "string",
            content : "send me image"
        }
        messageTextArea.value += "Send to Server => "+"datatype : "+webSockData.datatype+", content: "+webSockData.content+"\n";
        
        webSocket.send(JSON.stringify(webSockData));
         
        
    })
    // pose_data = webSocket.recv()
</script>
</body>
</html>